# Deploying AnyLog

The following provides the tools needed to deploy AnyLog using either a Kubernetes (via Helm) or Docker 
with docker-compose. For any other deployment format please reach out to us at [info@anylog.co](mailto:info@anylog.co).       

We recommend starting with our basic deployment - as shown in the diagram below; with _docker-compose_.

![deployment diagram](https://github.com/AnyLog-co/documentation/blob/master/imgs/deployment_diagram.png)

### AnyLog Version & Node Types
AnyLog has 3 major versions, each version is built on both _Ubuntu:20.04_ with _python:3.9-alpine_. 
* develop - is a stable release that's been used as part of our Test Network for a number of weeks, and gets updated every 4-6 weeks.
* predevelop - is our beta release, which is being used by our Test Network for testing purposes.
* testing - Any time there's a change in the code we deploy a "testing" image to be used for (internal) testing purposes. Usually the image will be Ubuntu based, unless stated otherwise.

| Build | Base Image | CPU Architecture | Pull Command | Size | 
|---|---|---|---|---|
| develop | Ubuntu:20.04 | amd64,arm/v7,arm64 | `docker pull anylogco/anylog-network:develop` | 664MB | 
| develop-alpine | python:3.9-alpine | amd64,arm/v7,arm64 | `docker pull anylogco/anylog-network:develop-alpine` | 460MB| 
| predevelop | Ubuntu:20.04 | amd64,arm/v7,arm64 | `docker pull anylogco/anylog-network:predevelop` | ~245MB | 
| predevelop-alpine | python:3.9-alpine | amd64,arm/v7,arm64 | `docker pull anylogco/anylog-network:predevelop-alpine` | ~178MB | 
| testing | Ubuntu:20.04 | amd64,arm/v7,arm64 | `docker pull anylogco/anylog-network:testing` |

By default, the AnyLog image is configured to run as a _REST_ node, which means that the TCP and REST options 
are running, but no other process is enabled. This allows for users to play with the system with no other services 
running in the background, but already having the default network configurations. The other major node types are:
* Master - A node that's dedicated to managing the ledger on the blockchain (database)  
* Operator - Node that contains the data generated by devices and sensors
* Publisher - Node to distribute data coming in from different devices and sensors across the different operator nodes 
* Query - Node dedicated to query the data, usually connected to a BI tool, such as Grafana 

For a basic deployment of an AnyLog REST node, you can execute the following command: 
```shell
docker run --network host -it --detach-keys="ctrl-d" --name anylog-node --rm anylogco/anylog-network:develop
```

## Node Setup
0. Install [Docker](installations/docker_install.sh) or [Kubernetes with Helm](installations/kube_install.sh)

1. (Optional) Install `dotenv` for utilizing [deployment scripts](deployment_scripts)
```bash
# using python3-pip
python3 -m pip install dotenv 

# using apt-get if python3-pip command fails 
sudo apt-get -y install python3-dotenv
```
2. Log into docker to download AnyLog - Contact [info@anylo.co](mailto:info@anylo.co) to get 
credentials to log into Docker if you were not alreaddy provided with one.  
    * [Docker Credentials](installations/docker_credentials.sh) 
    ```shell
    bash deployments/installations/docker_credentials.sh ${DOCKER_PASSWORD}
    ```
    * [Kubernetes Credentials](installations/kube_credentials.sh)
    ```shell
    bash deployments/installations/kube_credentials.sh ${DOCKER_PASSWORD}
    ```
3. Install relevant database(s), if using something other than _SQLite_
    * [PostgreSQL](https://www.digitalocean.com/community/tutorials/how-to-install-postgresql-on-ubuntu-20-04-quickstart) 
      * [Docker](docker-compose/postgres) 
      * [Kubernetes](helm/postgres)
    * [MongoDB](https://www.digitalocean.com/community/tutorials/install-mongodb-linux#install-mongodb-on-linux) 
      * [Docker](docker-compose/mongodb)

## Deploying AnyLog
* **Option 1**: Manually update the configuration file(s) and deploy AnyLog
```shell
# docker 
# 1. update .env file and anylog_configs.env

# 2. execute docker-compose command
cd ~/deployments/docker-compose/${ANYLOG_NODE}
docker-compose up -d 

# Helm
# 0. Package Helm if you change it
helm package ~/deployments/helm/anylog-node

# 1. update relevant file in $HOME/deployments/helm/sample-configurations

# 2. execute helm install  
helm install ~/deployments/helm/packages/anylog-node-1.22.3.tgz --values ~/deployments/configurations/helm/${CONFIG_FILE}.yaml --name-template ${NAME}
```


* **Option 2**: Utilize [deployment script](deployment_scripts/deploy_node.sh) to deploy AnyLog
```shell
bash $HOME/deployments/deployment_scripts/deploy_node.sh
```

## Support 
* [AnyLog Documentation](https://github.com/AnyLog-co/documentation) - documentation for AnyLog  
* [AnyLog API](https://github.com/AnyLog-co/AnyLog-API) - A python package to easily communicate with AnyLog via REST
